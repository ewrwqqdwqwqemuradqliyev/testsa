<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <title>Elan Detalları</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* CSS kodları (əvvəlki kimi qalır) */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e67e22;
            --light-bg: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --label-color: #555;
            --border-color: #e0e0e0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
            color: var(--text-color);
        }

        .navbar {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-left, .nav-center, .nav-right {
            display: flex;
            align-items: center;
        }

        .nav-left a.logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            font-size: 26px;
            font-weight: 700;
            color: var(--primary-color);
            transition: color 0.3s ease;
        }

        .nav-left a.logo:hover {
            color: var(--accent-color);
        }

        .nav-left a, .nav-right a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            margin-left: 25px;
            font-size: 16px;
            transition: color 0.3s ease;
        }

        .nav-left a:hover, .nav-right a:hover {
            color: var(--accent-color);
        }

        .nav-center .search-box {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 50px;
            background-color: var(--light-bg);
            max-width: 550px;
            width: 100%;
            overflow: hidden;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.05);
        }

        .nav-center .search-box input {
            border: none;
            background: transparent;
            outline: none;
            padding: 12px 20px;
            font-size: 15px;
            color: var(--text-color);
            flex-grow: 1;
        }

        .nav-center .search-box button {
            padding: 12px 25px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .nav-center .search-box button:hover {
            background-color: #d35400;
        }

        .profile-menu {
            position: relative;
            cursor: pointer;
        }

        .profile-menu .profile-btn {
            display: flex;
            align-items: center;
            color: var(--text-color);
            font-weight: 500;
            font-size: 16px;
            padding: 10px 18px;
            border: 1px solid var(--border-color);
            border-radius: 50px;
            background-color: var(--light-bg);
            transition: background-color 0.3s;
        }

        .profile-menu .profile-btn:hover {
            background-color: #e9ecef;
        }

        .profile-menu .dropdown {
            display: none;
            position: absolute;
            top: 60px;
            right: 0;
            background-color: var(--card-bg);
            min-width: 220px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            padding: 10px 0;
        }

        .profile-menu .dropdown a {
            display: flex;
            align-items: center;
            padding: 14px 25px;
            color: var(--text-color);
            font-weight: 400;
            transition: background-color 0.3s;
            margin: 0;
        }

        .profile-menu .dropdown a:hover {
            background-color: #f1f1f1;
        }

        .profile-menu .dropdown a i {
            margin-right: 12px;
            color: var(--accent-color);
        }

        .page-container {
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .ad-detail-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }

        .ad-image-section {
            flex: 2;
            position: relative;
        }

        .carousel-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 12px;
        }

        .carousel-images {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }

        .carousel-image {
            width: 100%;
            height: auto;
            flex-shrink: 0;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
            padding: 0 10px;
            box-sizing: border-box;
            pointer-events: none;
        }

        .nav-button {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            pointer-events: all;
        }

        .ad-info-section {
            flex: 1;
            padding-top: 10px;
        }

        .ad-info-section h1 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }

        .ad-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        .ad-description-container {
            margin-top: 30px;
            padding: 30px;
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .ad-description-container h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .ad-description-container p {
            line-height: 1.6;
            margin: 0;
        }

        .ad-meta-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .ad-meta-item {
            background-color: var(--light-bg);
            border-radius: 10px;
            padding: 15px;
            flex: 1 1 calc(50% - 20px);
            box-sizing: border-box;
        }

        .ad-meta-item strong {
            display: block;
            font-size: 0.9rem;
            color: var(--label-color);
            margin-bottom: 5px;
        }

        .ad-meta-item span {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .auction-section {
            background-color: var(--light-bg);
            border-radius: 15px;
            padding: 25px;
        }

        .auction-section h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .auction-section p {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-color);
        }

        .auction-bid-form {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            align-items: center;
        }

        .auction-bid-form input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        .auction-bid-form button {
            padding: 12px 25px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .auction-bid-form button:hover {
            background-color: #d35400;
        }

        .bid-info-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9e9e9;
            border-radius: 8px;
        }

        .error-message {
            color: #c0392b;
            font-weight: 600;
            margin-top: 15px;
        }

        .message-seller-section {
            margin-top: 20px;
            text-align: center;
        }

        .message-seller-section button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .message-seller-section button:hover {
            background-color: #d35400;
        }

        .message-seller-section button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .ad-meta-item {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-left">
        <a href="/dashboard" class="logo">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/Tap.az_logo.svg/2560px-Tap.az_logo.svg.png" alt="Logo">
            Tap.az
        </a>
        <a href="/dashboard">Kataloq</a>
    </div>
    <div class="nav-center">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Əşya və ya xidmət axtarışı">
            <button id="filterBtn">Filterlər</button>
            <button id="searchBtn">Axtar</button>
        </div>
    </div>
    <div class="nav-right" id="profileMenu">
        <a href="/addAdPage" class="add-ad-btn">+ Yeni Elan</a>
        <div class="profile-menu">
            <a id="profileBtn" class="profile-btn"><i class="fas fa-user-circle"></i> Profil ▾</a>
            <div class="dropdown" id="profileDropdown">
                <a href="/myAdsPage"><i class="fas fa-list-alt"></i> Paylaşılan Elanlar</a>
                <a href="/chatlist"><i class="fas fa-comment-alt"></i> Mesajlar</a>
                <a href="/accountPage"><i class="fas fa-cog"></i> Hesab Məlumatları</a>
                <a href="/logout"><i class="fas fa-sign-out-alt"></i> Çıxış</a>
            </div>
        </div>
    </div>
</div>

<div class="page-container">
    <div class="ad-detail-card" id="ad-details-container">
    </div>
    <div id="ad-description-area"></div>
</div>

<script>
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');
    const adDetailsContainer = document.getElementById('ad-details-container');
    const adDescriptionArea = document.getElementById('ad-description-area');
    const adCode = window.location.pathname.split('/').pop();

    let currentImageIndex = 0;
    let images = [];
    let sellerUserId = null;
    let currentAdId = null;

    profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
    });

    document.addEventListener('click', () => {
        profileDropdown.style.display = 'none';
    });

    async function fetchAndRenderAd() {
        try {
            const response = await fetch(`/getAd/${adCode}`);
            if (!response.ok) {
                if (response.status === 404) {
                    adDetailsContainer.innerHTML = '<p>Elan tapılmadı.</p>';
                    return;
                }
                throw new Error('Elan məlumatlarını yükləmək mümkün olmadı.');
            }
            const ad = await response.json();
            // ************ ƏSAS MƏQAM BURADA: Satıcının ID-si alınır ************
            sellerUserId = ad.userId;
            currentAdId = ad.id;
            renderAd(ad);

        } catch (error) {
            console.error('Xəta:', error);
            adDetailsContainer.innerHTML = `<p>${error.message}</p>`;
        }
    }

    async function renderAd(ad) {
        const currentUserResponse = await fetch('/me');
        const currentUser = await currentUserResponse.json();

        let priceHtml = '';
        let interactionHtml = '';
        let sellerInfoHtml = '';

        const isAuctionEnded = ad.ad_type === 'auction' && ad.isEnded;
        const isMyAd = currentUser && currentUser.id === ad.userId;

        const sellerName = ad.seller_info || 'Məlumat yoxdur';
        const sellerPhone = ad.seller_phone || 'Məlumat yoxdur';

        if (ad.ad_type === 'auction') {
            priceHtml = '';
            if (isAuctionEnded) {
                interactionHtml = `<p class="error-message">Hərrac başa çatıb.</p>`;
            } else {
                interactionHtml = `
                    <div class="auction-section">
                        <h3>Hərrac</h3>
                        <p>Auksionun bitmə vaxtı: <strong id="countdown-timer">Yüklənir...</strong></p>
                        <p>Son təklif: <strong id="current-bid">${ad.currentPrice} AZN</strong></p>
                        <form id="bid-form" class="auction-bid-form">
                            <input type="number" id="bid-amount" placeholder="Təklif etdiyin məbləğ" min="${ad.currentPrice + 1}" required>
                            <button type="submit">Təklif et</button>
                        </form>
                        <p id="bid-message"></p>
                    </div>
                `;
            }
            sellerInfoHtml = `
                <div class="ad-meta-item">
                    <strong>Satıcı</strong>
                    <span>${sellerName}</span>
                </div>
                <div class="ad-meta-item">
                    <strong>Əlaqə Nömrəsi</strong>
                    <span>${sellerPhone}</span>
                </div>
            `;
        } else {
            priceHtml = `<div class="ad-price">${ad.buyNowPrice !== undefined ? ad.buyNowPrice : 'Qiymət göstərilməyib'} AZN</div>`;
            sellerInfoHtml = `
                <div class="ad-meta-item">
                    <strong>Satıcı</strong>
                    <span>${sellerName}</span>
                </div>
                <div class="ad-meta-item">
                    <strong>Əlaqə Nömrəsi</strong>
                    <span>${sellerPhone}</span>
                </div>
            `;
        }

        // ************ DÜYMƏNİN HTML BLOKU ************
        let messageButtonHtml = '';
        if (currentUser && currentUser.id !== ad.userId) {
            messageButtonHtml = `
                <div class="message-seller-section">
                    <button id="message-btn">Satıcıya Mesaj Göndər</button>
                </div>
            `;
        } else if (!currentUser) {
            messageButtonHtml = `
                <div class="message-seller-section">
                    <button id="message-btn">Daxil Olub Mesaj Göndər</button>
                </div>
            `;
        } else {
            // Elan sahibinin mesaj düyməsini görməməsi üçün boş qoyuruq
        }
        // **********************************************

        let propertiesHtml = '';
        if (ad.properties && Object.keys(ad.properties).length > 0) {
            for (const key in ad.properties) {
                if (ad.properties[key] !== null && ad.properties[key] !== undefined && ad.properties[key] !== '') {
                    propertiesHtml += `
                        <div class="ad-meta-item">
                            <strong>${key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</strong>
                            <span>${ad.properties[key]}</span>
                        </div>
                    `;
                }
            }
        }

        let imageHtml = '';
        images = ad.images || (ad.image ? [ad.image] : []);
        if (images.length > 0) {
            imageHtml = `
                <div class="carousel-container">
                    <div class="carousel-images" id="carousel-images"></div>
                    <div class="carousel-nav">
                        <button class="nav-button" id="prev-btn">&lt;</button>
                        <button class="nav-button" id="next-btn">&gt;</button>
                    </div>
                </div>
            `;
        } else {
            imageHtml = '<p>Şəkil yoxdur.</p>';
        }

        adDetailsContainer.innerHTML = `
            <div class="ad-image-section">
                ${imageHtml}
            </div>
            <div class="ad-info-section">
                <h1>${ad.title}</h1>
                ${priceHtml}
                <div class="ad-meta-grid">
                    <div class="ad-meta-item">
                        <strong>Kateqoriya</strong>
                        <span>${ad.category}</span>
                    </div>
                    <div class="ad-meta-item">
                        <strong>Alt-kateqoriya</strong>
                        <span>${ad.subcategory}</span>
                    </div>
                    ${sellerInfoHtml}
                    ${propertiesHtml}
                </div>
                ${interactionHtml}
                ${messageButtonHtml}
            </div>
        `;

        adDescriptionArea.innerHTML = `
            <div class="ad-description-container">
                <h2>Açıqlama</h2>
                <p>${ad.description}</p>
            </div>
        `;

        if (ad.ad_type === 'auction' && !isAuctionEnded) {
            startCountdown(ad.endTime);
            setupAuction(ad, currentUser);
        }

        if (images.length > 0) {
            renderCarousel();
        }

        // ************ DÜYMƏNİN KLİK HADİSƏSİ ************
        const messageBtn = document.getElementById('message-btn');
        if (messageBtn) {
            messageBtn.addEventListener('click', () => {
                if (currentUser && currentUser.id) {
                    // Satıcının ID-si (sellerUserId) və elanın ID-si (currentAdId) ilə çata yönləndir
                    window.location.href = `/chat/${sellerUserId}/${currentAdId}`;
                } else {
                    alert('Mesaj göndərmək üçün daxil olmalısınız.');
                    window.location.href = '/login';
                }
            });
        }
        // **********************************************
    }

    function renderCarousel() {
        // ... (carousel funksiyaları)
        const carouselImagesContainer = document.getElementById('carousel-images');
        if (!carouselImagesContainer) return;

        carouselImagesContainer.innerHTML = '';
        images.forEach(image => {
            const imgElement = document.createElement('img');
            imgElement.src = image;
            imgElement.alt = "Elan şəkli";
            imgElement.className = "carousel-image";
            carouselImagesContainer.appendChild(imgElement);
        });

        updateCarousel();

        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        if (prevBtn) prevBtn.addEventListener('click', showPrevImage);
        if (nextBtn) nextBtn.addEventListener('click', showNextImage);
    }

    function updateCarousel() {
        const carouselImagesContainer = document.getElementById('carousel-images');
        if (!carouselImagesContainer) return;

        const offset = -currentImageIndex * 100;
        carouselImagesContainer.style.transform = `translateX(${offset}%)`;
    }

    function showNextImage() {
        currentImageIndex = (currentImageIndex + 1) % images.length;
        updateCarousel();
    }

    function showPrevImage() {
        currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
        updateCarousel();
    }

    function startCountdown(endTime) {
        // ... (auction countdown funksiyası)
        const countdownElement = document.getElementById('countdown-timer');
        if (!countdownElement) return;
        const end = endTime;

        const updateCountdown = setInterval(() => {
            const now = Date.now();
            const distance = end - now;

            if (distance < 0) {
                clearInterval(updateCountdown);
                countdownElement.textContent = 'Hərrac bitdi';
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }, 1000);
    }

    function setupAuction(ad, currentUser) {
        // ... (auction socket funksiyaları)
        const socket = io({
            query: {
                userId: currentUser.id
            }
        });
        const bidForm = document.getElementById('bid-form');
        const bidInput = document.getElementById('bid-amount');
        const bidMessage = document.getElementById('bid-message');
        const currentBidElement = document.getElementById('current-bid');

        socket.on('connect', () => {
            socket.emit('joinAdRoom', ad.id);
        });

        socket.on('updateBid', (data) => {
            currentBidElement.textContent = `${data.amount} AZN`;
            bidInput.min = data.amount + 1;
        });

        socket.on('bidError', (data) => {
            bidMessage.textContent = data.message;
            bidMessage.style.color = 'red';
        });

        socket.on('auctionEnded', (data) => {
            if (data.winner == currentUser.id) {
                window.location.href = `/auction-winner/${data.adId}`;
            } else {
                const auctionSection = document.querySelector('.auction-section');
                if(auctionSection) {
                    auctionSection.innerHTML = `
                        <p class="error-message">Hərrac başa çatdı. Siz qalib gəlmədiniz.</p>
                    `;
                }
            }
        });

        if (bidForm) {
            bidForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const bidAmount = parseFloat(bidInput.value);
                if (bidAmount > ad.currentPrice) {
                    socket.emit('newBid', { adId: ad.id, amount: bidAmount });
                    bidMessage.textContent = '';
                } else {
                    bidMessage.textContent = 'Təklifiniz mövcud qiymətdən yüksək olmalıdır.';
                    bidMessage.style.color = 'red';
                }
            });
        }
    }

    fetchAndRenderAd();
</script>

</body>
</html>